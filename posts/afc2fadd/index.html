
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>系统设计常见组件 - 并发锁、分布式锁与无锁编程 | CombinatorX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="李瑞">
    

    <meta name="keywords" content="distributed lock,optimistic lock,pessimistic lock,redlock,cas,乐观锁,悲观锁,分布式锁">
    
    <meta name="description" content="常见的锁分类类型并发锁乐观锁乐观锁是指实现方在并发产生的竞争条件还是乐观的，只是在发现数据被改变的时候才放弃修改。常见的实现模式是结合数据库进行。具体的实现方式是：前提条件：  在需要做乐观锁并发控制的表定义上添加修改版本号version字段的定义 DB的事务隔离级别为RR   在修改临界区资源之前先查询该资源（临界区资源数值、version 字段数值） 根据之前查询到的version并做更新条件">
<meta property="og:type" content="article">
<meta property="og:title" content="系统设计常见组件 - 并发锁、分布式锁与无锁编程">
<meta property="og:url" content="https://blogs.lirui.me/posts/afc2fadd/index.html">
<meta property="og:site_name" content="CombinatorX">
<meta property="og:description" content="常见的锁分类类型并发锁乐观锁乐观锁是指实现方在并发产生的竞争条件还是乐观的，只是在发现数据被改变的时候才放弃修改。常见的实现模式是结合数据库进行。具体的实现方式是：前提条件：  在需要做乐观锁并发控制的表定义上添加修改版本号version字段的定义 DB的事务隔离级别为RR   在修改临界区资源之前先查询该资源（临界区资源数值、version 字段数值） 根据之前查询到的version并做更新条件">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-12-30T11:15:16.000Z">
<meta property="article:modified_time" content="2020-06-04T11:36:58.608Z">
<meta property="article:author" content="李瑞">
<meta property="article:tag" content="算法,移动开发,项目管理,机器学习,面试,Algorithm,Data structure,mobile,Machine learning,TensorFlow,iOS,Android,interview,Java,Python,Linux,Mac,Web,Project Management,System design,Docker">
<meta name="twitter:card" content="summary">

    
    <link rel="alternative" href="/atom.xml" title="CombinatorX" type="application/atom+xml">
    
    <!--  -->

    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/%02.css">
<link rel="stylesheet" href="/.css">

    
<meta name="generator" content="Hexo 5.4.0"></head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="CombinatorX">CombinatorX</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/categories/Algorithm">算法数据结构</a></li>
					
						<li><a href="/categories/System-Design">系统设计</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" autocomplete="off" name="q" maxlength="20" placeholder="搜索" />
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/posts/afc2fadd/" title="系统设计常见组件 - 并发锁、分布式锁与无锁编程" itemprop="url">系统设计常见组件 - 并发锁、分布式锁与无锁编程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="李瑞" target="_blank" itemprop="author">李瑞</a>
		
  <p class="article-time">
    <time datetime="2019-12-30T11:15:16.000Z" itemprop="datePublished"> 发表于 2019-12-30</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E9%94%81%E5%88%86%E7%B1%BB%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text">常见的锁分类类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E9%94%81"><span class="toc-number">1.1.</span> <span class="toc-text">并发锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">乐观锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">悲观锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.2.</span> <span class="toc-text">分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%82%B2%E8%A7%82%E9%94%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">数据库悲观锁实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-SETNX-DELE-%E6%8C%87%E4%BB%A4%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">Redis SETNX DELE 指令实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.3.</span> <span class="toc-text">Redis 集群模式下的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Java-%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0-redisson"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">Java 语言实现 redisson</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E8%AF%AD%E8%A8%80%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0-redlock-py"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">Python 语言同步实现 redlock-py</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E8%AF%AD%E8%A8%80%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0-aioredlock"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">Python 语言异步实现 aioredlock</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zookeeper%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.4.</span> <span class="toc-text">Zookeeper实现方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91"><span class="toc-number">1.3.</span> <span class="toc-text">无锁并发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CAS"><span class="toc-number">1.3.1.</span> <span class="toc-text">CAS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">各种锁的使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.1.</span> <span class="toc-text">分布式锁使用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
		
		</div>
		
		<h2 id="常见的锁分类类型"><a href="#常见的锁分类类型" class="headerlink" title="常见的锁分类类型"></a>常见的锁分类类型</h2><h3 id="并发锁"><a href="#并发锁" class="headerlink" title="并发锁"></a>并发锁</h3><h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><p>乐观锁是指实现方在并发产生的竞争条件还是乐观的，只是在发现数据被改变的时候才放弃修改。<br>常见的实现模式是结合数据库进行。<br>具体的实现方式是：<br>前提条件：</p>
<ol>
<li>在需要做乐观锁并发控制的表定义上添加修改版本号<code>version</code>字段的定义</li>
<li>DB的事务隔离级别为RR</li>
</ol>
<ul>
<li>在修改临界区资源之前先查询该资源（临界区资源数值、version 字段数值）</li>
<li>根据之前查询到的version并做更新条件进行数值更新操作，同时将version版本加1</li>
</ul>
<h4 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h4><p>悲观锁是指实现方在并发产生的竞争条件悲观的，所以在数据更新之前是需要锁住临界区资源防止被其他资源修改。<br>常见的实现也是结合关系型数据库进行。<br>具体实现方式是：<br>前提条件：</p>
<ol>
<li>查询操作（主要是考虑幂等性）和更新操作需要在同一事务中</li>
</ol>
<p>具体到Java版的实现细节就是：<br>下面以一个购物下单的功能场景为例：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">order</span>`  (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `order_no` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `pay_money` <span class="type">decimal</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `status` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `create_date` datetime(<span class="number">0</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `delete_flag` <span class="type">int</span>(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `idx_status`(`status`) <span class="keyword">USING</span> BTREE,</span><br><span class="line">  INDEX `idx_order`(`order_no`) <span class="keyword">USING</span> BTREE</span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB</span><br></pre></td></tr></table></figure>

<p>这里的表需要定义为InnoDB存储引擎，用来支持事务。  </p>
<p>查询订单操作的SQL写为：  </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id <span class="keyword">from</span> `<span class="keyword">order</span>` <span class="keyword">where</span> `order_no`<span class="operator">=</span> <span class="string">&#x27;xxxx&#x27;</span> <span class="keyword">for</span> update</span><br></pre></td></tr></table></figure>

<p>这里的 <code>SELECT FOR UPDATE</code> 主要是基于gap lock机制的悲观锁实现，所以会存在阻塞的潜在问题。  </p>
<p>在创建订单的service 层代码：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addOrderRecord</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (orderDao.selectOrderRecord(order) == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> result = orderDao.addOrderRecord(order);</span><br><span class="line">    <span class="keyword">if</span> (result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><h4 id="数据库悲观锁实现方式"><a href="#数据库悲观锁实现方式" class="headerlink" title="数据库悲观锁实现方式"></a>数据库悲观锁实现方式</h4><p>同上</p>
<h4 id="Redis-SETNX-DELE-指令实现方式"><a href="#Redis-SETNX-DELE-指令实现方式" class="headerlink" title="Redis SETNX DELE 指令实现方式"></a>Redis <code>SETNX</code> <code>DELE</code> 指令实现方式</h4><p>Redis 中可以使用 <a target="_blank" rel="noopener" href="http://redis.io/commands/del"><code>SET</code></a> 和 <a target="_blank" rel="noopener" href="http://redis.io/commands/set"><code>DELE</code></a> 指令来实现。  </p>
<ul>
<li><p>Python 版本实现</p>
<ul>
<li><p>获取锁<br><a target="_blank" rel="noopener" href="https://github.com/nutshellfool/python-redis-pattern/blob/983a09ec1dd4fa1a16018c84f8697a8ec0f5f8c7/app.py#L117">Python 版本实现</a></p>
</li>
<li><p>释放锁<br><a target="_blank" rel="noopener" href="https://github.com/nutshellfool/python-redis-pattern/blob/983a09ec1dd4fa1a16018c84f8697a8ec0f5f8c7/app.py#L140">Python 版本实现</a></p>
</li>
</ul>
</li>
<li><p>Java 版本实现</p>
<ul>
<li><p>获取锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOCK_SUCCESS = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_IF_NOT_EXIST = <span class="string">&quot;NX&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SET_WITH_EXPIRE_TIME = <span class="string">&quot;PX&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Acquire distributed lock</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> jedis Redis client</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> lockKey lock key</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> requestId unique request ID</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> expireTime lock expire time</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> acquire success or no</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">acquireDistributedLock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Jedis jedis, String lockKey, String requestId, <span class="keyword">int</span> expireTime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String result =</span><br><span class="line">        jedis.set(lockKey, requestId, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, expireTime);</span><br><span class="line">    <span class="keyword">return</span> LOCK_SUCCESS.equals(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>释放锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCRIPT_UNLOCK =</span><br><span class="line"><span class="string">&quot;if redis.call(&#x27;get&#x27;, KEYS[1]) == ARGV[1] then return redis.call(&#x27;del&#x27;, KEYS[1]) else return 0 end&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">releaseLock</span><span class="params">(Jedis jedis, String lockKey, String requestId)</span> </span>&#123;</span><br><span class="line">  List&lt;String&gt; keys = Collections.singletonList(lockKey);</span><br><span class="line">  List&lt;String&gt; args = Collections.singletonList(requestId);</span><br><span class="line">  Object evalResult = jedis.eval(SCRIPT_UNLOCK, keys, args);</span><br><span class="line">  <span class="keyword">return</span> Integer.valueOf(<span class="number">1</span>).equals(evalResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h4 id="Redis-集群模式下的解决方案"><a href="#Redis-集群模式下的解决方案" class="headerlink" title="Redis 集群模式下的解决方案"></a>Redis 集群模式下的解决方案</h4><p>在集群下的实现，目前官方提供了多个基于 redlock 算法的语言实现版本，具体可以查看官网 <a target="_blank" rel="noopener" href="https://redis.io/topics/distlock#implementations">Distributed locks with Redis - Implementations</a></p>
<p>更多的 redlock 算法细节可以参考官方 RedisLab 的这篇文章 <a target="_blank" rel="noopener" href="https://redislabs.com/redis-best-practices/communication-patterns/redlock/">Redis Best Practices - Communication Patterns - Redlock</a></p>
<h5 id="Java-语言实现-redisson"><a href="#Java-语言实现-redisson" class="headerlink" title="Java 语言实现 redisson"></a>Java 语言实现 <a target="_blank" rel="noopener" href="https://github.com/redisson/redisson">redisson</a></h5><p>引入依赖：  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建配置 <a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/2.-Configuration#241-cluster-settings">redisson - cluster mode configuration</a>：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RedissonClient <span class="title">redissonClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Config config = <span class="keyword">new</span> Config();</span><br><span class="line">  config</span><br><span class="line">      .useClusterServers()</span><br><span class="line">      .setScanInterval(<span class="number">2000</span>)<span class="comment">// cluster state scan interval in milliseconds</span></span><br><span class="line">      <span class="comment">// use &quot;rediss://&quot; for SSL connection</span></span><br><span class="line">      .addNodeAddress(<span class="string">&quot;redis://127.0.0.1:6000&quot;</span>)</span><br><span class="line">      .setPassword(<span class="string">&quot;000000&quot;</span>)</span><br><span class="line">      .addNodeAddress(<span class="string">&quot;redis://127.0.0.1:6001&quot;</span>)</span><br><span class="line">      .setPassword(<span class="string">&quot;000000&quot;</span>)</span><br><span class="line">      .addNodeAddress(<span class="string">&quot;redis://127.0.0.1:6002&quot;</span>)</span><br><span class="line">      .setPassword(<span class="string">&quot;000000&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/8.-distributed-locks-and-synchronizers#84-redlock">redisson - distributed locks and synchronizers</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">redissonUsage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> waitTimeout = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">long</span> leaseTime = <span class="number">1</span>;</span><br><span class="line">  RLock lock1 = redissonClient1.getLock(<span class="string">&quot;lock1&quot;</span>);</span><br><span class="line">  RLock lock2 = redissonClient2.getLock(<span class="string">&quot;lock2&quot;</span>);</span><br><span class="line">  RLock lock3 = redissonClient3.getLock(<span class="string">&quot;lock3&quot;</span>);</span><br><span class="line"></span><br><span class="line">  RedissonRedLock redLock = <span class="keyword">new</span> RedissonRedLock(lock1, lock2, lock3);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    redLock.tryLock(waitTimeout, leaseTime, TimeUnit.SECONDS);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    redLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然 Redisson 还提供 异步支持 和 Reactive、RxJava 响应式编程范式支持，从这个层面上来看 Redisson 是 Java 生态中可优先考虑的 Redis 客户端。<br>以上的例子主要是考虑与 Spring-Data-Redis 的整合，如果考虑与 Spring-boot 进行整合，可以参考 <a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/tree/master/redisson-spring-boot-starter#spring-boot-starter">redisson redisson-spring-boot-starter</a><br>更多框架整合的信息可参考 <a target="_blank" rel="noopener" href="https://github.com/redisson/redisson/wiki/14.-Integration-with-frameworks">Redisson - Integration with frameworks</a></p>
<h5 id="Python-语言同步实现-redlock-py"><a href="#Python-语言同步实现-redlock-py" class="headerlink" title="Python 语言同步实现 redlock-py"></a>Python 语言同步实现 <a target="_blank" rel="noopener" href="https://github.com/SPSCommerce/redlock-py">redlock-py</a></h5><h5 id="Python-语言异步实现-aioredlock"><a href="#Python-语言异步实现-aioredlock" class="headerlink" title="Python 语言异步实现 aioredlock"></a>Python 语言异步实现 <a target="_blank" rel="noopener" href="https://github.com/joanvila/aioredlock">aioredlock</a></h5><h4 id="Zookeeper实现方式"><a href="#Zookeeper实现方式" class="headerlink" title="Zookeeper实现方式"></a>Zookeeper实现方式</h4><p>// TODO</p>
<h3 id="无锁并发"><a href="#无锁并发" class="headerlink" title="无锁并发"></a>无锁并发</h3><h4 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h4><p>Compare And Set (CAS) 是一种无锁并发处理的机制。  </p>
<p>// TODO</p>
<h2 id="各种锁的使用场景"><a href="#各种锁的使用场景" class="headerlink" title="各种锁的使用场景"></a>各种锁的使用场景</h2><h3 id="分布式锁使用场景"><a href="#分布式锁使用场景" class="headerlink" title="分布式锁使用场景"></a>分布式锁使用场景</h3><p>分布式锁一般会在下面的两个场景下使用。</p>
<ul>
<li>高并发场景下保证共享资源操作的原子性</li>
<li>避免分布式环境下不同节点执行重复任务</li>
</ul>
<p>第一个场景不难理解，最常见的就是电商平台的库存扣减。<br>第二个场景，举个例子，例如在分布式的环境下可能有多个短信发送服务实例，如果发送的逻辑不做协调和控制就可能出现多个短信服务向同一个用户发送的情况。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://redis.io/topics/distlock">Distributed locks with Redis</a></li>
<li><a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/125983">如何设计更优的分布式锁？</a></li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/System-Design/">System Design</a>
</div>


</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://blogs.lirui.me/posts/afc2fadd/" data-title="系统设计常见组件 - 并发锁、分布式锁与无锁编程 | CombinatorX" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/posts/8e8be6ee/" title="LaTeX简明教程">
  <strong>上一篇：</strong><br/>
  <span>
  LaTeX简明教程</span>
</a>
</div>


<div class="next">
<a href="/posts/1fe35790/"  title="CI/CD - Python Django 项目在 Jenkins 上的实践">
 <strong>下一篇：</strong><br/> 
 <span>CI/CD - Python Django 项目在 Jenkins 上的实践
</span>
</a>
</div>

</nav>

	

<section id="comments" class="comment">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E9%94%81%E5%88%86%E7%B1%BB%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text">常见的锁分类类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E9%94%81"><span class="toc-number">1.1.</span> <span class="toc-text">并发锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">1.1.1.</span> <span class="toc-text">乐观锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%82%B2%E8%A7%82%E9%94%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">悲观锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">1.2.</span> <span class="toc-text">分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%82%B2%E8%A7%82%E9%94%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">数据库悲观锁实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-SETNX-DELE-%E6%8C%87%E4%BB%A4%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.2.</span> <span class="toc-text">Redis SETNX DELE 指令实现方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E9%9B%86%E7%BE%A4%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">1.2.3.</span> <span class="toc-text">Redis 集群模式下的解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Java-%E8%AF%AD%E8%A8%80%E5%AE%9E%E7%8E%B0-redisson"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">Java 语言实现 redisson</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E8%AF%AD%E8%A8%80%E5%90%8C%E6%AD%A5%E5%AE%9E%E7%8E%B0-redlock-py"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">Python 语言同步实现 redlock-py</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Python-%E8%AF%AD%E8%A8%80%E5%BC%82%E6%AD%A5%E5%AE%9E%E7%8E%B0-aioredlock"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">Python 语言异步实现 aioredlock</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Zookeeper%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="toc-number">1.2.4.</span> <span class="toc-text">Zookeeper实现方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91"><span class="toc-number">1.3.</span> <span class="toc-text">无锁并发</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CAS"><span class="toc-number">1.3.1.</span> <span class="toc-text">CAS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E9%94%81%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">各种锁的使用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.1.</span> <span class="toc-text">分布式锁使用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/Algorithm/" title="Algorithm">Algorithm<sup>16</sup></a></li>
		  
		
		  
			<li><a href="/categories/Cloud-Native/" title="Cloud Native">Cloud Native<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Efficiency/" title="Efficiency">Efficiency<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Machine-Learning/" title="Machine Learning">Machine Learning<sup>2</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/Management/" title="Management">Management<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Management/" title="Management">Management<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network/" title="Network">Network<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Operations/" title="Operations">Operations<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/Programming-Languages/" title="Programming Languages">Programming Languages<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Reading-Notes/" title="Reading Notes">Reading Notes<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/System-Design/" title="System Design">System Design<sup>8</sup></a></li>
		  
		
		</ul>
</div>


  

  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coolshell.cn/" target="_blank" title="酷壳">酷壳</a>
            
          </li>
        
          <li>
            
            	<a href="https://blog.cleancoder.com/" target="_blank" title="The Clean Code Blog">The Clean Code Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://blog.youxu.info/" target="_blank" title="4G Spaces(徐宥)">4G Spaces(徐宥)</a>
            
          </li>
        
    </ul>
</div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		
				<div class="cc-license">
          <a href="http://creativecommons.org/licenses/by-nc/4.0" class="cc-opacity" target="_blank">
            <img src="/img/cc-by-nc.svg" alt="Creative Commons" />
          </a>
        </div>
    

		<p class="copyright">
		<!-- Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> -->
		© 2022
		
		<a href="/about" target="_blank" title="李瑞">李瑞</a>
		
		<!-- and <a target="_blank" rel="noopener" href="https://pages.github.com" style="font-weight: bold">GitHub</a> -->
		</p>
		<p class="copyright">
			Hosted by <a target="_blank" rel="noopener" href="https://pages.coding.me" style="font-weight: bold">Coding Pages</a>
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>




<script type="text/javascript">

var disqus_shortname = 'nutshellfool';

(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
(function(){
  var dsq = document.createElement('script');
  dsq.type = 'text/javascript';
  dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
}());
</script>






<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->

<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-96909480-1', 'blogs.lirui.me');  
ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?da064bc11a3418ff9faed4f05b877de9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

